# Use POSIX-compliant Makefiles
.POSIX:

# Clear suffix list
.SUFFIXES:

package = @PACKAGE_TARNAME@
version = @PACKAGE_VERSION@
tarname = $(package)
distdir = $(tarname)-$(version)
prefix  = @prefix@

# VPATH-related substitution variables
srcdir = @srcdir@
VPATH  = @srcdir@

shared_lib=$(srcdir)/lib/libqmckl.so
static_lib=$(srcdir)/lib/libqmckl.a
qmckl_h=$(srcdir)/include/qmckl.h
qmckl_f=$(srcdir)/share/$(package)/fortran/qmckl_f.f90

datarootdir=$(prefix)/share
datadir=$(datarootdir)
docdir=$(datarootdir)/doc/$(package)
libdir=$(prefix)/lib
includedir=$(prefix)/include
fortrandir=$(datarootdir)/$(package)/fortran

export prefix shared_lib static_lib qmckl_h qmckl_f datarootdir datadir docdir libdir includedir fortrandir package


all clean doc install uninstall check:
	$(MAKE) -C src $@

dist: $(distdir).tar.gz

$(distdir).tar.gz: $(distdir)
	tar chof - $(distdir) | gzip -9 -c > $@
	rm -rf $(distdir)


$(distdir): $(qmckl_h) $(qmckl_f) $(static_lib) $(shared_lib) $(srcdir)/src/Makefile.generated doc FORCE
	mkdir -p $(distdir)
	mkdir -p $(distdir)/munit
	mkdir -p $(distdir)/src
	mkdir -p $(distdir)/include
	mkdir -p $(distdir)/share/qmckl/fortran
	mkdir -p $(distdir)/share/doc/qmckl/html/
	mkdir -p $(distdir)/share/doc/qmckl/text/
	mkdir -p $(distdir)/man
	cp $(srcdir)/munit/munit.h munit/munit.c $(distdir)/munit/
	cp $(srcdir)/src/*.c src/*.h src/*.f90 $(distdir)/src/
	cp $(srcdir)/src/Makefile.generated.in $(distdir)/src/Makefile.in
	cp $(srcdir)/config.h.in $(distdir)/config.h.in
	cp $(qmckl_h) $(distdir)/include
	cp $(srcdir)/Makefile.in $(distdir)/
	cp $(srcdir)/share/doc/qmckl/html/*.html $(distdir)/share/doc/qmckl/html/
	cp $(srcdir)/share/doc/qmckl/html/*.css  $(distdir)/share/doc/qmckl/html/
	cp $(srcdir)/share/doc/qmckl/text/*.txt  $(distdir)/share/doc/qmckl/text/
	cp $(qmckl_f) $(distdir)/share/qmckl/fortran/
	cp $(srcdir)/configure.ac.dist $(distdir)/configure.ac
	cp $(srcdir)/qmckl.pc.in $(distdir)/qmckl.pc.in
	cp -r $(srcdir)/m4 $(distdir)/m4
	mkdir -p $(distdir)/lib
	cd $(distdir) && ../autogen.sh


FORCE:
	rm -f -- $(distdir).tar.gz
	rm -rf -- $(distdir)


distcheck: $(distdir).tar.gz
	gzip -cd $(distdir).tar.gz | tar xvf -
	cd $(distdir) && ./configure --enable-debug
	cd $(distdir) && $(MAKE) all 
	cd $(distdir) && $(MAKE) check
	cd $(distdir) && $(MAKE) DESTDIR=$${PWD}/_inst install
	cd $(distdir) && $(MAKE) DESTDIR=$${PWD}/_inst uninstall
	@remaining="`find $${PWD}/$(distdir)/_inst -type f | wc -l`" ;\
		if test "$${remaining}" -ne 0; then \
			echo "*** $${remaining} file(s) remaining in stage directory"; \
			exit 1; \
		fi
	cd $(distdir) && $(MAKE) clean
	rm -rf $(distdir)
	@echo "*** Package $(distdir).tar.gz is ready for distribution."


$(qmckl_h) $(qmckl_f) $(static_lib) $(shared_lib):
	$(MAKE) -C src $@ 

$(srcdir)/src/Makefile.generated: 
	$(MAKE) -C src Makefile.generated

veryclean: FORCE clean


.PHONY: all veryclean clean dist doc install uninstall FORCE
