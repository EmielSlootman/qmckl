# Header

# We want the Makefile to be POSIX-compliant, such that it works not
# only with GNU Make.


# This file was created by tools/Building.org

.POSIX:

# Compiler options

# Compiler variables are obtained from the configure script (see =configure.ac=)


CC      = @CC@
FC      = @FC@
CFLAGS  = @CFLAGS@
FCFLAGS = @FCFLAGS@
LDFLAGS = @LDFLAGS@

# Variables


HAS_CPPCHECK = @HAS_CPPCHECK@

QMCKL_ROOT=$(shell dirname $(CURDIR))

shared_lib=$(QMCKL_ROOT)/lib/libqmckl.so
static_lib=$(QMCKL_ROOT)/lib/libqmckl.a
qmckl_h=$(QMCKL_ROOT)/include/qmckl.h
qmckl_f=$(QMCKL_ROOT)/share/qmckl/fortran/qmckl_f.f90

export CC CFLAGS FC FCFLAGS LIBS QMCKL_ROOT

ORG_SOURCE_FILES=$(wildcard $(QMCKL_ROOT)/*.org)
C_SOURCE_FILES=$(patsubst %.org,%.c,$(ORG_SOURCE_FILES))
INCLUDE=-I$(QMCKL_ROOT)/include/

# Rules

# The source files are created during the generation of the file ~Makefile.generated~.
# The Makefile.generated is the one that will be distributed with the library.


.PHONY: clean shared static doc all check install uninstall
.SECONDARY: # Needed to keep the produced C and Fortran files

$(shared_lib) $(static_lib): $(qmckl_h) $(qmckl_f) Makefile.generated
	$(MAKE) -f Makefile.generated $@

install uninstall: Makefile.generated
	$(MAKE) -f Makefile.generated $@

$(qmckl_f) $(qmckl_h): Makefile.generated
	$(QMCKL_ROOT)/tools/build_qmckl_h.sh

shared: $(shared_lib)
static: $(static_lib)
all: shared static doc check

check: $(static_lib)
	$(MAKE) -f Makefile.generated check

ifeq ($(HAS_CPPCHECK),1)
cppcheck:
	cppcheck \
	--addon=cert \
	--enable=warning,style,performance,portability,information \
	qmckl_*.c
endif

doc: $(ORG_SOURCE_FILES)
	$(QMCKL_ROOT)/tools/build_doc.sh

clean:
	- $(MAKE) -f Makefile.generated clean
	- $(RM)	test_qmckl_* test_qmckl.c \
		$(qmckl_h) $(qmckl_f) \
		qmckl_*.f90 qmckl_*.c qmckl_*.h \
		Makefile.generated *.html *.txt

veryclean: clean FORCE
	- $(RM)	$(QMCKL_ROOT)/share/doc/qmckl/html/*.html \
	$(QMCKL_ROOT)/share/doc/qmckl/text/*.txt

Makefile.generated.in: Makefile $(QMCKL_ROOT)/tools/create_makefile.sh  $(ORG_SOURCE_FILES) ../tools/Building.org
	$(QMCKL_ROOT)/tools/create_makefile.sh

Makefile.generated: Makefile.generated.in 
	cd .. ; ./config.status

.SUFFIXES: .org .c

.org.c:
	$(QMCKL_ROOT)/tools/tangle.sh $<
